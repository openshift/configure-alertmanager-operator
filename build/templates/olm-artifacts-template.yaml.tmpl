apiVersion: v1
kind: Template
metadata:
  name: olm-artifacts-template

parameters:
- name: REGISTRY_IMG
  required: true
- name: CHANNEL
  value: staging
  required: true
- name: IMAGE_TAG
  value: latest
  required: true

objects:
- apiVersion: hive.openshift.io/v1alpha1
  kind: SelectorSyncSet
  metadata:
    generation: 1
    name: configure-alertmanager-operator
  spec:
    clusterDeploymentSelector:
      matchLabels:
        api.openshift.com/managed: "true"
    resourceApplyMode: sync
    resources:
    - apiVersion: operators.coreos.com/v1alpha1
      kind: CatalogSource
      metadata:
        labels:
          opsrc-datastore: "true"
          opsrc-provider: redhat
        name: configure-alertmanager-operator-registry
        namespace: openshift-operator-lifecycle-manager
      spec:
        image: ${REGISTRY_IMG}:${CHANNEL}-${IMAGE_TAG}
        displayName: Configure Alertmanager Operator
        icon:
          base64data: ""
          mediatype: ""
        publisher: Red Hat
        sourceType: grpc
    - apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: configure-alertmanager-operator
        namespace: openshift-monitoring
      spec:
        channel: ${CHANNEL}
        name: configure-alertmanager-operator
        source: configure-alertmanager-operator-registry
        sourceNamespace: openshift-operator-lifecycle-manager
    - apiVersion: monitoring.coreos.com/v1
    kind: PrometheusRule
    metadata:
      name: configure-alertmanager-operator
      namespace: openshift-monitoring
    spec:
      groups:
      - name: configure-alertmanager-operator
        rules:
        - alert: Mismatch_between_DMS_secret_and_DMS_Alertmanager_config
          annotations:
            message: "Mismatch between DMS secret and DMS AlertManager config"
            link_url: "https://access.redhat.com/articles/4165971"
          expr: dms_secret_exists + am_secret_contains_dms = 1
          for: 5m
          labels:
            severity: critical
        - alert: Mismatch_between_PD_secret_and_PD_Alertmanager_config
          annotations:
            message: "Mismatch between PD secret and PD AlertManager config"
            link_url: "https://access.redhat.com/articles/4165971"
          expr: pd_secret_exists + am_secret_contains_pd = 1
          for: 5m
          labels:
            severity: critical
        - alert: Alertmanager_config_secret_does_not_exist
          annotations:
            message: "Alertmanager config secret does not exist"
            link_url: "https://access.redhat.com/articles/4165971"
          expr: am_secret_exists = 0
          for: 5m
          labels:
            severity: critical
